# gongxunsai-zhen

<!--
 * @,@Author: ,: 冯家乐
 * @,@Date: ,: 2021-03-05 19:36:46
 * @,@LastEditTime: ,: 2021-03-05 20:49:48
 * @,@LastEditors: ,: Please set LastEditors
 * @,@Description: ,: In User Settings Edit
 * @,@FilePath: ,: \test\README.md
 -->

## 整体控制流程    
#### 自检阶段   
- 树莓派、32上电，32进入等待状态，准备接收串口的ready信号  
- 上位机UI启动程序写入etc/rc.local自启动，UI程序启动图像识别程序，同时UI显示自检中  
- UI程序建立有名管道，识别程序通过管道发送ready给UI程序  
- **UI程序每一秒向串口发送ready信号，32在收到ready信号后返回ready信号**  
- 自检完毕  
#### 检测阶段
- 点击“垃圾分类功能”，开始播放视频，视频结束后UI通过管道通知识别程序开始工作    
- 识别程序不断进行检测，当检测到载物台为空时不发送任何信号   
- 当首次检测到空时，识别程序等待2-3s，然后空读取几十帧画面解决帧滞留问题    
- 当识别程序检测到连续稳定的结果时，通过管道发送给UI，UI进行显示  
- **UI程序每隔一秒发送倾倒垃圾指令，并进入等待状态，发送倾倒垃圾指令直到收到下位机的确认指令**  
- **当32收到倾倒垃圾指令后，应立即返回确认指令，然后将垃圾扔到垃圾桶**   
- **32将垃圾扔到垃圾桶后，将载物台归位，同时给上位机发送垃圾倾倒完成指令**  
- **UI程序收到垃圾倾倒完成指令后，结束等待状态，重新进入工作状态**  
- <u>**注意，当因为某些原因32已经开始扔垃圾，但是仍然收到倾倒垃圾指令，比如上位机没有收到确认指令，或者串口通讯存在延迟，那么下位机应该忽视这条指令，同时再次返回确认指令**</u>  
#### 满载检测阶段
- 此阶段暂时未考虑  
****************************************
## 通信协议  
### 通讯配置  
- 波特率115200，数据位8bits，停止位1，校验位none  
### 协议格式  
- 1+2+1，固定开始位+指令位+参数位+固定结束位  
> 第一位为0x75，为固定开始位  
> 第二位为指令位，分为ready，确认指令，倾倒指令，倾倒完成指令，具体见下  
> 第三位为参数位，不同的指令有不同的参数，具体见下  
> 第四位为0x00，为固定结束位    
### 指令详解  
- 确认指令  
> 此指令为确认指令，当32收到任意一条指令时都应发送该指令表示收到，指令位为0x01，参数位固定为0x01，此条指令格式固定  
> 固定码 0x75, 0x01, 0x01, 0x00  
- reday指令  
> 此指令为自检阶段上下位机表示自己已经准备工作，指令位为0x02，参数位固定为0x10，此条指令格式固定  
> 固定码 0x75, 0x02, 0x10, 0x00  
- 倾倒指令    
> 此指令为倾倒指令，由上位机发送给下位机，指令位为0x03，有4种参数，参数位可以为0x01, 0x02, 0x03, 0x04，表示第一，第二，第三，第四个垃圾桶   
> 指令示例 0x75, 0x03, 0x01, 0x00，表示将垃圾扔到第一个垃圾桶    
> 0x75, 0x03, 0x03, 0x00，表示扔到第三个垃圾桶    
- 倾倒完成指令  
> 此指令为倾倒完成指令，有下位机发送给上位机，指令位为0x04,参数位固定为0x01,此条指令格式固定  
> 固定码 0x75, 0x04, 0x01, 0x00  